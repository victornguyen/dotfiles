#!/usr/bin/env bash

# Sets some sensible defaults for OSX.
# Stolen liberally from mathiasbynens:
# https://mths.be/macos

source "${HOME}/.dotfiles/scripts/lib/utils"

# Close any open System Preferences panes, to prevent them from overriding
# settings weâ€™re about to change
osascript -e 'tell application "System Preferences" to quit'

# Ask for the administrator password upfront
sudo -v

# Keep-alive: update existing `sudo` time stamp until `.macos` has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# Loop through scripts in macos/ and run
e_header "Applying sensible MacOS settings..."
macos_dir="$HOME/.dotfiles/scripts/macos"
if [[ -d "$macos_dir" && -n "$(ls -A "$macos_dir" 2>/dev/null)" ]]; then
  for file in "$macos_dir"/*; do
    if [[ -f "$file" ]]; then
      e_step "Applying $file"
      bash "$file"
    fi
  done
else
  e_warning "No macOS configuration scripts found in $macos_dir"
fi

# Restart System Preferences to ensure all changes take effect
sudo pkill -f "System Preferences" 2>/dev/null || true
