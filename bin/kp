#!/bin/zsh

# Kill Process
# Displays output of "ps -eo" in a fzf multiselect
# Stolen and tweaked from:
# https://github.com/SidOfc/dotfiles/blob/d07fa3862ed065c2a5a7f1160ae98416bfe2e1ee/zsh/kp
# <tab> to select one or multiple entries
# <enter> to kill selected processes and go back to the process list.
# <ctrl+p> to show parent processes of the selected process

local kp_header=$(ps -eo pcpu,pid,ppid,user,args -r | sed 1q)
local initial_processes=$(ps -eo pcpu,pid,ppid,user,args -r | sed 1d)
local pid=$(
  echo "$initial_processes" | fzf \
    "$@" \
    -m \
    --reverse \
    --header="$kp_header" \
    --prompt="Processes > " \
    --bind "ctrl-p:change-prompt('Parent > ')+reload(ps -p \$(echo {} | awk '{print \$3}') -o pcpu,pid,ppid,user,args | sed 1d)" \
    --bind "ctrl-r:change-prompt('Processes > ')+reload(echo \"$initial_processes\")" |
    awk '{print $2}'
)

if [ "x$pid" != "x" ]
then
  echo $pid | xargs kill -${1:-9}
  kp
fi
